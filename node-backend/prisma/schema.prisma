// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

//Enums
enum UserType {
  user
  admin
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Define your models below
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  userType  UserType @default(user)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallets              Wallet[]
  sentTransactions     Transaction[]      @relation("FromUser")
  receivedTransactions Transaction[]      @relation("ToUser")
  sentWithdrawals      Withdrawal[]       @relation("WithdrawalUser")
  transferRequestsFrom TransferRequest[]  @relation("FromUserTransfer")
  transferRequestsTo   TransferRequest[]  @relation("ToUserTransfer")

  @@index([email])
  @@index([createdAt])
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String
  balance   Decimal  @default(0.00) @db.Decimal(15, 2)
  currency  String   @default("USD") @db.VarChar(3)
  version   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User          @relation(fields: [userId], references: [id])
  fromTransactions  Transaction[] @relation("FromWallet")
  toTransactions    Transaction[] @relation("ToWallet")

  @@unique([userId, currency])
  @@index([userId])
}

model Transaction {
  id               String            @id @default(uuid())
  transactionType  TransactionType
  status           TransactionStatus @default(PENDING)
  amount           Decimal           @db.Decimal(15, 2)
  currency         String            @default("USD") @db.VarChar(3)
  fromUserId       String?
  toUserId         String?
  fromWalletId     String?
  toWalletId       String?
  idempotencyKey   String?           @unique
  referenceId      String?
  errorMessage     String?           @db.Text
  createdAt        DateTime          @default(now())
  completedAt      DateTime?

  fromUser        User?             @relation("FromUser", fields: [fromUserId], references: [id])
  toUser          User?             @relation("ToUser", fields: [toUserId], references: [id])
  fromWallet      Wallet?           @relation("FromWallet", fields: [fromWalletId], references: [id])
  toWallet        Wallet?           @relation("ToWallet", fields: [toWalletId], references: [id])
  withdrawal      Withdrawal?
  transferRequest TransferRequest?

  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@index([transactionType])
  @@index([createdAt])
  @@index([idempotencyKey])
}

model TransferRequest {
  id            String         @id @default(uuid())
  fromUserId    String
  toUserId      String
  amount        Decimal        @db.Decimal(15, 2)
  status        TransferStatus @default(PENDING)
  transactionId String?        @unique
  createdAt     DateTime       @default(now())
  processedAt   DateTime?

  fromUser    User        @relation("FromUserTransfer", fields: [fromUserId], references: [id])
  toUser      User        @relation("ToUserTransfer", fields: [toUserId], references: [id])
  transaction Transaction? @relation(fields: [transactionId], references: [id])

  @@index([status])
  @@index([fromUserId])
}

model Withdrawal {
  id                String           @id @default(uuid())
  userId            String
  amount            Decimal          @db.Decimal(15, 2)
  status            WithdrawalStatus @default(PENDING)
  externalReference String?
  transactionId     String           @unique
  createdAt         DateTime         @default(now())
  completedAt       DateTime?

  user        User        @relation("WithdrawalUser", fields: [userId], references: [id])
  transaction Transaction @relation(fields: [transactionId], references: [id])

  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id            String   @id @default(uuid())
  transactionId String?
  action        String
  oldBalance    Decimal? @db.Decimal(15, 2)
  newBalance    Decimal? @db.Decimal(15, 2)
  userId        String?
  createdAt     DateTime @default(now())

  @@index([transactionId])
  @@index([userId])
  @@index([createdAt])
}
